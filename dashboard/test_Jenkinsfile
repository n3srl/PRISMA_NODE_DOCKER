node('docker') {  
    def dockerImage = null

	try {
		stage('Clone PRISMA DASHBOARD repository from GitHub') {
			dir('dashboard_src') {
		        deleteDir()
				sshagent(credentials: ['GitHub_SSH']) {
					sh """
						git clone --branch test git@github.com:n3srl/PRISMA_DASHBOARD.git 
					"""
				}
			}
		}
		stage('Build image') {
		   dir("dashboard"){
				def tag = "test-${env.BUILD_NUMBER}"
				def buildArgs = "--progress=plain --pull=true"
				
				if (params.FORCE_REBUILD) {
					buildArgs = " --no-cache"
				}
				
				dockerImage = docker.build("n3srl/prisma-dashboard:${tag}", "${buildArgs} .")
		   }
		}
		
		stage('Push image') {
			withDockerRegistry([ credentialsId: "n3_docker_hub", url: "" ]) {
				dockerImage.push()
			}
		}
		
		// Cleanup logic to remove Docker images/containers
        if (dockerImage) {
            echo "Cleaning up Docker image..."
            try {
                sh "docker rmi -f ${dockerImage.id}"
            } catch (Exception cleanupEx) {
                echo "Failed to remove Docker image: ${cleanupEx.getMessage()}"
            }
        }
		
		// Add this to remove the workspace
        echo "Cleaning up workspace..."
        deleteDir()
		
	} catch (Exception e) {
        // Handle any failure in the previous stages
        echo "An error occurred: ${e.getMessage()}"
		error "Pipeline failed due to an error: ${e.getMessage()}" 
    } 
}
