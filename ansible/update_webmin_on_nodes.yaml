---
- name: Update Docker containers on specified nodes
  hosts: guest_nodes
  become: no
  tasks:
    - name: Check for SSH on port 22
      wait_for:
        host: "{{ inventory_hostname }}"
        port: 22
        timeout: 2
      register: ssh_check
      
    - name: Move to the webmin source directory
      ansible.builtin.command:
        chdir: /prismadata/orma-src
        cmd: pwd
      register: pwd_result
    - debug:
        var: pwd_result.stdout

    - name: Fetch latest changes from the remote repository
      ansible.builtin.git:
        repo: /prismadata/orma-src
        fetch: yes
        
    - name: Reset the repository to a specific state
      ansible.builtin.shell: |
        git reset --hard
      args:
        executable: /bin/bash
        
    - name: Check current branch and switch to main if not on main
      ansible.builtin.git:
        repo: /prismadata/orma-src
        target: main
        switch: true
      register: git_switch_result
      when: git_switch_result.changed
      
    - name: Pull latest changes from the main branch
      ansible.builtin.git:
        repo: /prismadata/orma-src
        pull: yes
      register: git_pull_result
      when: git_switch_result.changed