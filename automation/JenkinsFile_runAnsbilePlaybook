node('docker') {
    // Parameters
    def ANSIBLE_PLAYBOOK_FILE = 'ansible/guest_node_update_freeture.yaml'
    def ANSIBLE_INVENTORY = 'ansible/inventory.ini'

    // Credentials
    def ANSIBLE_USER = credentials('ANSIBLE_USER')

    // Stage 1: Pull Ansible Docker Image
    stage('Pull Ansible Docker Image') {
        script {
            docker.image('alpinelinux/ansible').pull()
        }
    }

    // Stage 2: Run Ansible Playbook
    stage('Run Ansible Playbook') {
        withCredentials([usernamePassword(credentialsId: 'ANSIBLE_USER', passwordVariable: 'PASSWORD', usernameVariable: 'USERNAME')]) {
            // Using the Docker Pipeline plugin to run the playbook inside the Docker container
            docker.image('alpinelinux/ansible').inside("-v ${WORKSPACE}:/workspace") {
                // Make sure the playbook path is correct relative to the mounted volume
                sh "ansible-playbook -i /workspace/ansible/inventory.ini /workspace/${ANSIBLE_PLAYBOOK_FILE} -e ansible_user=${USERNAME} -e ansible_password=${PASSWORD}"
            }
        }
    }
}