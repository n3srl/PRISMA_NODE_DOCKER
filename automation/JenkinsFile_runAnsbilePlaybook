node('docker') {
    // Parameters
    def ANSIBLE_PLAYBOOK_FILE = 'ansible/guest_node_update_freeture.yaml'
    def ANSIBLE_INVENTORY = 'ansible/inventory.ini'
	def OPENVPN_CONF_CONTENT // This will hold the content of the openvpn.conf file

    // Credentials
    def ANSIBLE_USER = params.ANSIBLE_USER

    // Stage 1: Pull Ansible Docker Image
    stage('Pull Ansible Docker Image') {
        script {
            docker.image('alpinelinux/ansible').pull()
        }
    }

    // Stage 2: Run Ansible Playbook
    stage('Run Ansible Playbook') {
        withCredentials([usernamePassword(credentialsId: 'ANSIBLE_USER', passwordVariable: 'PASSWORD', usernameVariable: 'USERNAME')])
		{
            // Using the Docker Pipeline plugin to run the playbook inside the Docker container
            docker.image('alpinelinux/ansible').inside("-v \"${WORKSPACE}:/ansible\" -u root:root \"") {
                // Write the content of the openvpn.conf file
                writeFile file: '/ansible/openvpn.conf', text: OPENVPN_CONF_CONTENT

				// Make sure the playbook path is correct relative to the mounted volume
                sh """
				    cp \$OPENVPN_CONF_FILE /ansible/openvpn.conf
					apk add openvpn
					echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.d/ipv4.conf
					sysctl -p /etc/sysctl.d/ipv4.conf
					openvpn --config openvpn.conf
					ls /
					ls /ansible
					ansible-playbook -i ${ANSIBLE_INVENTORY}  ${ANSIBLE_PLAYBOOK_FILE}
				"""
            }
        }
    }
}